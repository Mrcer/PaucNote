# 实验 10-多周期处理器综合性开放实验
## 实验内容
编写一个特定功能的程序，实现C代码，翻译为汇编代码，汇编成机器代码，写入多周期CPU中完成仿真和上板，测试程序正确性
## 实验过程和结果分析
### 编写C程序
选择实现斐波那契数列计算，代码如下
```c
#include <stdio.h>

int main() {
    int n=32, pre2=1, pre1=1, res=2, idx=2;
    while(idx != n) {
        res = pre1 + pre2;
        pre2 = pre1;
        pre1 = res;
        ++idx;
    }
    printf("%d ", res);
    return 0;
}
```
经过gcc编译，程序可以正确输出斐波那契数列的第32项，即`2178309`
### 翻译为汇编代码
```mipsasm
.text
    li		$a0, 32		# n = 32    
    li		$s0, 1		# pre2 = 1
    li		$s1, 1		# pre1 = 1
    li		$v0, 2		# res = 2
    li		$s3, 2		# idx = 2
LOOP:  
    beq		$s3, $a0, END	# if idx == n then goto END
    add		$v0, $s1, $s0	# res = pre1 + pre2
    move 	$s0, $s1		# pre2 = pre1
    move 	$s1, $v0		# pre1 = res
    addi	$s3, $s3, 1		# ++idx
    j		LOOP			# jump to LOOP
END:
    j		END				# jump to END
```
为了简便，所有变量储存在寄存器中，对应位置如注释所示。结尾使用无限循环使CPU不再改变寄存器数据。经过MARS模拟器编译，在结尾处断点可以查看到`$v0`中的值为`0x213d05`，即`2178309`，符合预期结果。
### 翻译为机器代码
```
24040020
24100001
24110001
24020002
24130002
12640005
02301020
00118021
00028821
22730001
08000005
0800000b 
```
使用MARS以十六进制形式导出代码段数据，稍作修改后即可写入coe文件
### 仿真
使用上次实验完成的多周期CPU仿真（已实现上板），发现部分指令没有得到支持（部分I-type和无符号运算），对控制器稍作修改后得到正确的仿真结果。
![](./%E4%BB%BF%E7%9C%9F%E7%BB%93%E6%9E%9C.jpg)
图片中的信号分别为复位信号、时钟信号、当前运行指令、主控制器状态、查看的寄存器编号和对应数据。可以发现在最后一条指令处，2号寄存器（即`$v0`）数据为`0x213d05`，与MARS运行结果一致，符合预期。
### 上板
降低时钟频率后，完成上板，通过数码管可以看到2号寄存器的变化过程，最终低八位结果如下
![](./%E4%B8%8A%E6%9D%BF%E7%BB%93%E6%9E%9C.jpg)
通过高位选择可以补全数据，得到最终结果为`0x213d05`，符合预期

## 实验总结

使用FPGA上的CPU运行程序有以下步骤：
1. 编写程序，并用MARS翻译为机器码
2. 将机器码写入到coe文件，更新主存IP核
3. 仿真测试，观测结果是否符合预期
4. 上板调试